<chapter id="index"><?dbhtml dir="faq"?>
	<title>FAQ</title>
	<section id="reset.password">
		<title>Reset root password 重置MySQL root密码</title>
		<para>忘记root密码是使用 --skip-grant-tables 启动项</para>
		<para>CentOS 6.x</para>
		<screen>
		<![CDATA[
# vim /etc/init.d/mysqld

 $exec --skip-grant-tables  --datadir="$datadir" --socket="$socketfile" \
    --pid-file="$mypidfile" \
    --basedir=/usr --user=mysql >/dev/null 2>&1 &
		]]>
		</screen>
		<screen>
		<![CDATA[
# /etc/init.d/mysqld restart
Stopping mysqld:                                           [  OK  ]
Starting mysqld:                                           [  OK  ]

# mysqladmin -u root flush-privileges password "newpassword"
		]]>
		</screen>
		<section>
			<title>MySQL 5.7.x</title>
			<para>CentOS 7.x</para>
			<para>添加 skip-grant-tables=1 选项，然后重启mysql</para>
			<screen>
			<![CDATA[
# cat /etc/my.cnf
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html

[mysqld]
#
# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M
#
# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
# log_bin
#
# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
skip-grant-tables=1
# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0

# Recommended in standard MySQL setup
sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES 

[mysqld_safe]
log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid
			]]>
			</screen>

			<screen>
			<![CDATA[
# systemctl restart mysqld
			]]>
			</screen>
			<screen>
			<![CDATA[
update mysql.user set authentication_string=password('netkiller') where user='root' and Host = 'localhost';
flush privileges;
quit;
			]]>
			</screen>
			<screen>
			<![CDATA[
# mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.14 MySQL Community Server (GPL)

Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> update mysql.user set authentication_string=password('netkiller') where user='root' and Host = 'localhost';
Query OK, 1 row affected, 1 warning (0.03 sec)
Rows matched: 1  Changed: 1  Warnings: 1

mysql> flush privileges;
Query OK, 0 rows affected (0.00 sec)

mysql> quit;
Bye
			]]>
			</screen>
			<para>删除 skip-grant-tables=1 重启MySQL</para>
		</section>
		<section>
			<title>MySQL 8.0</title>
			<screen>
			<![CDATA[
[root@localhost log]# vim /etc/my.cnf

[mysqld]
skip-grant-table
			]]>
			</screen>
			<screen>
			<![CDATA[
ALTER USER root@localhost identified by 'MQiEge1ikst7S_6tlXzBOmt';
ALTER USER root@localhost PASSWORD EXPIRE NEVER;			
			]]>
			</screen>
		</section>

	</section>
	<section id="perror">
		<title>查看错误代码</title>
		<screen>
		<![CDATA[
mysql> \! perror 6
OS error code   6:  No such device or address
		]]>
		</screen>
		<section id="error.code">
			<title>ERROR 1153 (08S01) at line 3168: Got a packet bigger than 'max_allowed_packet' bytes</title>
			<screen>
				max_allowed_packet=500M
			</screen>
		</section>
		<section>
			<title>ERROR 1129 (00000): Host 'XXXXXX' is blocked because of many connection errors; unblock with 'mysqladmin flush-hosts'</title>
			<para>连接在中途被中断了的连接请求。在 max_connect_errors次失败请求后，mysql阻止该主机进一步的连接，直到管理员执行命令 mysqladmin flush-hosts。</para>
			<screen>
			<![CDATA[
mysql> flush hosts;
			]]>
			</screen>
			<screen>
				set global max_connect_errors=1000;
			</screen>
			<screen>
				max_connect_errors=10000
			</screen>
		</section>
	</section>
	<section id="tmptable">
		<title>临时表是否需要建索引</title>
		<para>答案：要</para>
	</section>
	<section id="max_open_files">
		<title>[Warning] Changed limits: max_open_files: 5000 (requested 20480)</title>
		<screen>
		<![CDATA[
2018-01-08T01:34:44.515973Z 0 [Warning] Changed limits: max_open_files: 5000 (requested 10240)
2018-01-08T01:34:44.516402Z 0 [Warning] Changed limits: table_open_cache: 1471 (requested 2000)		
		]]>
		</screen>
		<para>提出出现在 CentOS 7 ulimit 配置没有问题的情况下mysql日志提示 Warning</para>
		<screen>
			# ulimit -Sa | grep "open files"
			open files (-n) 40960
		</screen>
		<screen>
			[root@netkiller ~]# cat /proc/`pidof mysqld`/limits
			Limit Soft Limit Hard Limit Units
			Max cpu time unlimited unlimited seconds
			Max file size unlimited unlimited bytes
			Max data size unlimited unlimited bytes
			Max stack size 8388608 unlimited bytes
			Max core file size 0 unlimited bytes
			Max resident set unlimited unlimited bytes
			Max processes 63494 63494 processes
			Max open files 5000 5000 files
			Max locked memory 65536 65536 bytes
			Max address space unlimited unlimited bytes
			Max file locks unlimited unlimited locks
			Max pending signals 63494 63494 signals
			Max msgqueue size 819200 819200 bytes
			Max nice priority 0 0
			Max realtime priority 0 0
			Max realtime timeout unlimited unlimited us

		</screen>
		<para>动态改变</para>
		<screen>
			[root@netkiller ~]# egrep '^(Limit|Max open files)' /proc/`pidof mysqld`/limits
			Limit Soft Limit Hard Limit Units
			Max open files 5000 5000 files
		</screen>
		<para>问题的出现出现原因是systemctl启动脚本覆盖了ulimit配置</para>
		<screen>
			# cat /usr/lib/systemd/system/mysqld.service | grep -A2 open_files_limit
			# Sets open_files_limit
			LimitNOFILE = 5000
		</screen>
		<para>解决方法，直接修改上面的数值，不建议修改mysqld.service，这样会影响你下次升级。请采用下面的方案完美解决：</para>
		<screen>
		<![CDATA[
mkdir /usr/lib/systemd/system/mysqld.service.d

cat >> /usr/lib/systemd/system/mysqld.service.d/override.conf <<EOF
[Service]
LimitNOFILE=40960
EOF
		]]>
		</screen>
		<para>重启 MySQL</para>
		<screen>
			systemctl daemon-reload
			systemctl restart mysqld
		</screen>
		<para>检查是否生效</para>
		<screen>
		<![CDATA[
mysql> show variables like 'open_files_limit';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| open_files_limit | 65535 |
+------------------+-------+
1 row in set (0.01 sec)		
		]]>
		</screen>
	</section>



	<section id="ERROR.1055">
		<title>this is incompatible with sql_mode=only_full_group_by</title>
		<para>ERROR 1055 (42000): Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'mydb.contact.id' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by</para>
		<screen>
		<![CDATA[
mysql> select @@version;
+-----------+
| @@version |
+-----------+
| 5.7.10    |
+-----------+
1 row in set (0.00 sec)

mysql> select @@GLOBAL.sql_mode;
+-------------------------------------------------------------------------------------------------------------------------------------------+
| @@GLOBAL.sql_mode                                                                                                                         |
+-------------------------------------------------------------------------------------------------------------------------------------------+
| ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |
+-------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> SET sql_mode = '';
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> select id,name from contact group by name limit 10;
+-------+-------------+
| id    | name        |
+-------+-------------+
| 84046 |   张伟      |
| 80259 |   张磊      |
|   784 |   王岩      |
| 87685 |  杨钞       |
+-------+-------------+
10 rows in set (0.07 sec)
		
		]]>
		</screen>
		<para>不建议设置 SET sql_mode = ''，正确方式如下：</para>
		<screen>
		<![CDATA[
mysql> set global sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
mysql> set session sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';		
		]]>
		</screen>
		<para>或者采用</para>
		<screen>
		<![CDATA[		
Adding only one mode to sql_mode without removing existing ones:

SET sql_mode=(SELECT CONCAT(@@sql_mode,',<mode_to_add>'));
Removing only a specific mode from sql_mode without removing others:

SET sql_mode=(SELECT REPLACE(@@sql_mode,'<mode_to_remove>',''));
In your case, if you want to remove only ONLY_FULL_GROUP_BY mode, then use below command:

SET sql_mode=(SELECT REPLACE(@@sql_mode, 'ONLY_FULL_GROUP_BY', ''));		
		]]>
		</screen>
	</section>
	<section id="ERROR.1071">
		<title>ERROR 1071 (42000) at line 25: Specified key was too long; max key length is 767 bytes</title>
		<para>这个保存通常出现在高版本数据库向低版本数据导入数据，活着云主机例如阿里云。</para>
		<screen>
		<![CDATA[
mysql> show variables like '%innodb_large_prefix%';
+---------------------+-------+
| Variable_name       | Value |
+---------------------+-------+
| innodb_large_prefix | OFF   |
+---------------------+-------+
1 row in set (0.00 sec)		
		]]>
		</screen>
		<para>解决方案</para>
		<screen>
		<![CDATA[
innodb_large_prefix=ON		
		]]>
		</screen>
	</section>
	<section id="ERROR.1086">
		<title>ERROR 1086 (HY000): File '/var/lib/mysql-files/order.txt' already exists	</title>
		<para>SELECT * FROM tabname INTO OUTFILE 不支持覆盖操作，这是MySQL从安全角度考虑的。</para>
		<screen>
		<![CDATA[
mysql> SELECT * FROM `order` INTO OUTFILE '/var/lib/mysql-files/order.txt';
ERROR 1086 (HY000): File '/var/lib/mysql-files/order.txt' already exists		
		]]>
		</screen>
	</section>
	<section id="ERROR.1146">
		<title>Error Code: 1146. Table 'test.CACHE_UPDATE' doesn't exist	</title>
		<para>问题分析，首先确认表是存在的，但是无法读取。可以判定是 lower_case_table_names=1 选项的问题，开启后表以小写方式打开。</para>
		<screen>
		<![CDATA[
Error Code: 1146. Table 'test.CACHE_UPDATE' doesn't exist		
		]]>
		</screen>
		<para>如果是 MySQL 8.0 之前没有开启 lower_case_table_names=1 ，现在需要开启，加入配置后将无法启动，解决办法是，你需要重做 mysql data 目录</para>
		<screen>
		<![CDATA[
[root@localhost ~]# rm -rf /var/lib/mysql/*
[root@localhost ~]# systemctl restart mysqld
[root@localhost ~]# mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.21 Source distribution

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> show variables like '%lower_case_table_names%';
+------------------------+-------+
| Variable_name          | Value |
+------------------------+-------+
| lower_case_table_names | 1     |
+------------------------+-------+
1 row in set (0.01 sec)

mysql> SELECT CURRENT_SERIAL FROM CACHE_UPDATE WHERE ID=1;
+----------------+
| CURRENT_SERIAL |
+----------------+
|              7 |
+----------------+
1 row in set (0.00 sec)
		]]>
		</screen>

	</section>
	<section id="ERROR.1273">
		<title>ERROR 1273 (HY000) at line 3364: Unknown collation: 'utf8mb4_0900_ai_ci'</title>
		<para>找出指定字符集的表</para>
		<programlisting>
		<![CDATA[
select TABLE_SCHEMA,TABLE_NAME,TABLE_COLLATION from information_schema.tables where table_collation = 'utf8mb4_0900_ai_ci' and table_schema = 'your_schema';		
		]]>
		</programlisting>
		<programlisting>
		<![CDATA[
SELECT
	CONCAT(
		'ALTER TABLE ',
		TABLE_NAME,
		' CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;'
	)
FROM
	information_schema.`TABLES`
WHERE
	TABLE_SCHEMA = 'DATABASE_NAME';
		]]>
		</programlisting>
	</section>
	<section id="ERROR.1290">
		<title>ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement</title>
		<para>MySQL 不允许向 secure_file_priv 意外的目录导出文件。</para>
		<programlisting>
		<![CDATA[
mysql> SELECT * FROM `order` INTO OUTFILE '/tmp/order.txt';
ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement

mysql> show variables like '%secure%';
+--------------------------+-----------------------+
| Variable_name            | Value                 |
+--------------------------+-----------------------+
| require_secure_transport | OFF                   |
| secure_auth              | ON                    |
| secure_file_priv         | /var/lib/mysql-files/ |
+--------------------------+-----------------------+
3 rows in set (0.00 sec)

mysql> SELECT * FROM `order` INTO OUTFILE '/var/lib/mysql-files/order.txt';
Query OK, 3 rows affected (0.00 sec)

root@netkiller ~ % cat /var/lib/mysql-files/order.txt
1	Tom	22	2017-11-16 17:23:15
2	Neo	34.65	2017-11-16 17:29:28
3	Cici	34.98	2017-11-16 17:30:29
		]]>
		</programlisting>
		<para>在 my.cnf 中 加入 secure-file-priv=/tmp 可以修改为你需要的目录。</para>
	</section>
	<section id="ERROR.1364">
		<title>ERROR 1364: 1364: Field 'id' doesn't have a default value</title>
		<screen>
		<![CDATA[
set @@SESSION.sql_mode='NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
SELECT @@GLOBAL.sql_mode;
UPDATE `cms`.`content` SET `source`='test' WHERE `content_id`='1099';		
		]]>
		</screen>
	</section>
	<section id="ERROR.1415">
		<title>ERROR 1415: Not allowed to return a result set from a trigger</title>
		<para>触发器中不允许返回结果集，解决方法是顶一个变量，然后将返回值返回给变量。</para>
		<programlisting>
		<![CDATA[
DROP TRIGGER IF EXISTS `test`.`demo_AFTER_INSERT`;

DELIMITER $$
USE `test`$$
CREATE DEFINER=`root`@`%` TRIGGER `test`.`demo_AFTER_INSERT` AFTER INSERT ON `demo` FOR EACH ROW
BEGIN
	set @rev = "";
	SELECT 
    OUT2FILE('/tmp/demo.log',
            CONCAT_WS(',',
                    NEW.id,
                    NEW.name,
                    NEW.sex,
                    NEW.address))
	INTO @rev;
END$$
DELIMITER ;		
		]]>
		</programlisting>
	</section>
	<section id="ERROR.1503">
		<title>ERROR 1503 (HY000): A PRIMARY KEY must include all columns in the table's partitioning function</title>
		<ulink url="http://dev.mysql.com/doc/refman/5.1/en/partitioning-limitations-partitioning-keys-unique-keys.html" />
	</section>
	<section id="ERROR.1819">
		<title>ERROR 1819 (HY000): Your password does not satisfy the current policy requirements</title>
		<para>MySQL 5.7 密码强度，必须含有0-9，a-z,A-Z以及“-”或“_”</para>
		<para>https://dev.mysql.com/doc/refman/5.7/en/validate-password-options-variables.html</para>
		<para>禁用密码安全策略（早起5.7版本可用，新版已经废弃这个选项）</para>
		<screen>
			# cat /etc/my.cnf | grep validate-password
			validate-password=OFF
		</screen>
		<para>新的方式修改策略与密码长度</para>
		<screen>
		<![CDATA[
mysql> set global validate_password_policy=0;
mysql> set global validate_password_length=4;
mysql> grant all privileges on test.* to 'test'@localhost  identified by 'chen';
		]]>
		</screen>
	</section>
	<section id="ERROR.1820">
		<title>ERROR 1820 (HY000): You must reset your password using ALTER USER statement before executing this statement.</title>
		<para>这个错误来自 MySQL 5.7，首次登陆MySQL 5.7 必须修改密码</para>
		<screen>
			ALTER USER 'root'@'localhost' IDENTIFIED BY 'your_password';
		</screen>
	</section>
	<section id="ERROR.1840">
		<title>ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</title>
		<para>问题出现在 MySQL 5.7 导入数据库时候</para>
		<screen>
		<![CDATA[
[www@testing ~]$ zcat netkiller.2021-08-19.sql.gz | mysql netkiller
ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.		
		]]>
		</screen>
		<para>解决方案</para>
		<para>执行 reset master;</para>
		<screen>
		<![CDATA[
[www@testing ~]$ mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 25669
Server version: 5.7.35 MySQL Community Server (GPL)

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> reset master;
Query OK, 0 rows affected (0.01 sec)

mysql> exit
Bye
[www@testing ~]$ zcat netkiller.2021-08-19.sql.gz | mysql netkiller
		]]>
		</screen>
	</section>
	<section id="ERROR.2002">
		<title>ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock'</title>
		<para>错误提示</para>
		<screen>
		<![CDATA[
[root@stage stage]# mysql
ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock'		
		]]>
		</screen>
		<para>这种情况一般检查 my.cnf 中的 socket 配置项，看看 socket 被配置到了什么目录</para>
		<para>配置文件增加 socket 指向正确路径</para>
		<screen>
		<![CDATA[
[client]
socket=/your/path/mysql/mysql.sock
		]]>
		</screen>
		<para>通过参数指定</para>
		<screen>
		<![CDATA[
mysql -uroot -p --socket=/your/path/mysql/mysql.sock
		]]>
		</screen>
		<para>Docker 默认是 /var/run/mysqld/mysqld.sock 我们将其改为 /var/lib/mysql/mysql.sock</para>
		<screen>
		<![CDATA[
services:
  mysql:
    command:
    - --socket=/var/lib/mysql/mysql.sock
    - --default-authentication-plugin=mysql_native_password
    - --character-set-server=utf8mb4
    - --collation-server=utf8mb4_general_ci
    - --explicit_defaults_for_timestamp=true
    - --lower_case_table_names=1
    - --max_execution_time=0
    container_name: mysql
    depends_on: []
    environment:
    - TZ=Asia/Shanghai
    - MYSQL_ROOT_PASSWORD=passw0rd
    - MYSQL_DATABASE=netkiller
    - MYSQL_USER=netkiller
    - MYSQL_PASSWORD=netkiller
    hostname: db.netkiller.com
    image: mysql:5.7
    ports:
    - 3306:3306
    restart: always
    volumes:
    - /var/lib/mysql:/var/lib/mysql
    - /opt/netkiller.com/api.netkiller.cn/mysql/conf.d/server.cnf:/etc/mysql/conf.d/server.cnf
    - /opt/netkiller.com/api.netkiller.cn/mysql/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d		
		]]>
		</screen>
	</section>
	<section id="ERROR.3024">
		<title>ERROR 3024 (HY000): Query execution was interrupted, maximum statement execution time exceeded</title>
		<screen>
		<![CDATA[
mysql> select * from cert;
ERROR 3024 (HY000): Query execution was interrupted, maximum statement execution time exceeded
mysql> SET GLOBAL max_execution_time=10;
Query OK, 0 rows affected (0.01 sec)

mysql> select * from cert;
Empty set (0.08 sec)

mysql> show variables like 'max_execution_time';
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| max_execution_time | 10    |
+--------------------+-------+
1 row in set (0.01 sec)

mysql> select /*+ max_execution_time(3000)*/ count(*) from cert;
+----------+
| count(*) |
+----------+
|        0 |
+----------+
1 row in set (0.29 sec)
		]]>
		</screen>
	</section>


	<section id="caching_sha2_password.so">
		<title>Authentication plugin 'caching_sha2_password' cannot be loaded: /usr/lib64/mysql/plugin/caching_sha2_password.so: cannot open shared object file: No such fileor directory</title>
		<para>这个故障出现在 MySQL 8.0 上，用户使用 mysql client 5.7 链接 MySQL 8.0 提示如下</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# mysql -h 193.112.95.53 -uroot -p
Enter password:
ERROR 2059 (HY000): Authentication plugin 'caching_sha2_password' cannot be loaded: /usr/lib64/mysql/plugin/caching_sha2_password.so: cannot open shared object file: No such fileor directory
		]]>
		</screen>
		<para>解决方案，创建用户使用 mysql_native_password密码</para>
		<screen>
		<![CDATA[
mysql> CREATE USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'pMQiEge1ikst7S_6tlXzBOmt_4b';
Query OK, 0 rows affected (0.08 sec)

mysql> grant all on *.* to 'root'@'%';
Query OK, 0 rows affected (0.08 sec)
		]]>
		</screen>
		<para>重新链接</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# mysql -h 193.112.95.53 -uneo -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 24
Server version: 8.0.11 MySQL Community Server - GPL

Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
		]]>
		</screen>
	</section>
	<section>
		<title>com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Public Key Retrieval is not allowed</title>
		<para>问题出在现在 MySQL 8.0 版本</para>
		<para>解决方法：在连接后面添加 allowPublicKeyRetrieval=true</para>
		<screen>
		<![CDATA[
spring.datasource.url=jdbc:mysql://192.168.0.1:3306/test?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true
		]]>
		</screen>
	</section>
	<section id="mysqldump.column-statistics">
		<title>mysqldump: Couldn't execute 'SELECT COLUMN_NAME,</title>
		<para>问题出现在 MySQL 8.0 备份 MySQL 5.7 数据库时。</para>
		<screen>
		<![CDATA[
mysqldump: Couldn't execute 'SELECT COLUMN_NAME, JSON_EXTRACT(HISTOGRAM, '$."number-of-buckets-specified"')                FROM information_schema.COLUMN_STATISTICS                WHERE SCHEMA_NAME = 'testra' AND TABLE_NAME = 'branch';': Unknown table 'column_statistics' in information_schema (1109)		
		]]>
		</screen>
		<para>解决办法，使用 --column-statistics=0 选项</para>
		<screen>
		<![CDATA[
mysqldump -hdb.netkiller.cn -uroot -ptest neo --column-statistics=0
		]]>
		</screen>
	</section>
	<section id="only_full_group_by">
		<title>this is incompatible with sql_mode=only_full_group_by</title>
		<screen>
		<![CDATA[
Expression #2 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'test.table.username' which
is not functionally dependent on columns in GROUP BY clause;
this is incompatible with sql_mode=only_full_group_by		
		]]>
		</screen>
		<para>问题出在 MySQL 5.7 向 MySQL 8.0 迁移。</para>
		<para>查询 sql_mode 设置</para>
		<screen>
		<![CDATA[
select @@global.sql_mode;		
'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'
		]]>
		</screen>
		<para>临时解决方案，去掉 ONLY_FULL_GROUP_BY 即可</para>
		<screen>
		<![CDATA[
set @@GLOBAL.sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO, NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
set @@SESSION.sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO, NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';		
		]]>
		</screen>
		<itemizedlist>
			<title>彻底解决，有三种解决方案：</title>
			<listitem>第一种，将 MySQL 的版本降回到 5.7</listitem>
			<listitem>第二种，关闭 only_full_group_by 检查</listitem>
			<listitem>第三种，修改sql使其遵守only_full_group_by语法规则</listitem>
		</itemizedlist>
		<para>采用哪个方案？打工人的方案，就是解决眼前问题，如果你对项目负责，最好采用第三种方案。</para>
		<para>我的职业生涯遇到无数次，因版本太低同时发现重大漏洞，厂商已经不在维护该版本，此时一边是黑客攻击，一边你又无法短时间内升级到新版本，公司又不能接受停服，你会怎么应对？我用了很多非常规手段，给开发团队争取了一周的时间，升级系统。</para>
	</section>
	<section id="mysqldump.Warning">
		<title>mysqldump: [Warning] Using a password on the command line interface can be insecure.</title>
		<screen>
		<![CDATA[
mysqldump: [Warning] Using a password on the command line interface can be insecure.		
		]]>
		</screen>
		<para></para>
		<screen>
		<![CDATA[
vim ~/.my.cnf 

[mysqldump]
user=root
password=123456
		]]>
		</screen>
		<screen>
		<![CDATA[
[root@netkiller neo]# mysqldump -h 192.168.30.40 neo
[root@netkiller neo]# mysqldump --defaults-extra-file=~/.my.cnf netkiller > netkiller.sql		
		]]>
		</screen>
	</section>
	<section id="mysql.Warning">
		<title>mysql: [Warning] Using a password on the command line interface can be insecure.</title>
		<para>当使用 -pnetkiller 在命令行出现密码的时候，会提示下面信息。</para>
		<screen>
		<![CDATA[
[www@testing ~]$ mysql -h127.0.0.1 -uneo -pnetkiller test
mysql: [Warning] Using a password on the command line interface can be insecure.
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 25623
Server version: 5.7.35 MySQL Community Server (GPL)

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 
		
		]]>
		</screen>
		<para>创建 ~/.my.cnf 配置文件，将密码写入配置</para>
		<screen>
		<![CDATA[
[www@testing ~]$ cat ~/.my.cnf 
[mysql]
host=127.0.0.1
user=neo
password=netkiller
		]]>
		</screen>
		<para>这时直接使用 mysql 命令即可进入。</para>
		<screen>
		<![CDATA[
[www@testing ~]$ mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 25622
Server version: 5.7.35 MySQL Community Server (GPL)

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>		
		]]>
		</screen>
	</section>

</chapter>
